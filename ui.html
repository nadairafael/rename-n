<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    :root {
      /* Colors */
      --color-bg: #2c2c2c;
      --color-bg-secondary: #383838;
      --color-bg-tertiary: #444444;
      --color-bg-inverse: #ffffff;
      --color-bg-brand: #0c8ce9;
      --color-text: #ffffff;
      --color-text-default: #ffffff;
      --color-text-secondary: rgba(255, 255, 255, 0.7);
      --color-text-tertiary: rgba(255, 255, 255, 0.4);
      --color-text-oninverse: rgba(255, 255, 255, 0.9);
      --color-text-onbrand: #ffffff;
      --color-text-danger: #fca397;
      --color-text-success: #4ade80;
      --color-border: #444444;
      --color-bordertranslucent: rgba(255, 255, 255, 0.1);
      --color-icon: #ffffff;
      
      /* Spacing */
      --spacer-1: 4px;
      --spacer-2: 8px;
      --spacer-4: 16px;
      --spacer-6: 40px;
      
      /* Radius */
      --radius-medium: 5px;
      
      /* Heights */
      --height-input: 24px;
      
      /* Typography */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-family-mono: 'SF Mono', 'Monaco', 'Courier New', monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      font-size: 11px;
      font-weight: 450;
      line-height: 16px;
      color: var(--color-text);
      background: var(--color-bg);
      overflow: hidden;
    }

    .plugin-container {
      display: flex;
      flex-direction: column;
      background: var(--color-bg);
      overflow: hidden;
    }

    /* Header - Removido */

    /* Content */
    .content {
      display: flex;
      flex-direction: column;
      gap: var(--spacer-4);
      padding: var(--spacer-4);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: var(--spacer-1);
    }

    .tab {
      height: var(--height-input);
      padding: 0 var(--spacer-2);
      background: var(--color-bg);
      border: none;
      border-radius: var(--radius-medium);
      font-family: var(--font-family);
      font-size: 11px;
      font-weight: 450;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.055px;
      white-space: nowrap;
    }

    .tab.active {
      background: var(--color-bg-secondary);
      color: var(--color-text);
      font-weight: 550;
      display: flex;
      align-items: center;
      gap: var(--spacer-1);
    }

    .tab:hover:not(.active) {
      background: var(--color-bg-tertiary);
    }

    .tab-badge {
      background: var(--color-bg-tertiary);
      color: var(--color-text);
      padding: 0 var(--spacer-1);
      border-radius: var(--radius-medium);
      font-size: 11px;
      font-weight: 450;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 16px;
    }

    /* Input Section */
    .input-section {
      display: flex;
      flex-direction: column;
      gap: var(--spacer-1);
    }

    .input-label {
      font-size: 11px;
      color: var(--color-text-secondary);
      letter-spacing: 0.055px;
    }

    .input-wrapper {
      height: var(--height-input);
      background: var(--color-bg-secondary);
      border-radius: var(--radius-medium);
      display: flex;
      align-items: center;
      gap: var(--spacer-1);
      padding-left: 2px;
      padding-right: var(--spacer-2);
    }

    .badge {
      background: #2c2c2c;
      color: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: var(--radius-medium);
      font-size: 11px;
      font-weight: 450;
      letter-spacing: 0.055px;
      line-height: 16px;
    }

    /* Cards */
    .cards {
      display: flex;
      flex-direction: column;
      gap: var(--spacer-2);
    }

    .card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-medium);
      padding: var(--spacer-2);
      display: flex;
      flex-direction: column;
      gap: var(--spacer-1);
    }


    .errors-label {
      font-size: 11px;
      font-weight: 450;
      color: var(--color-text-secondary);
      letter-spacing: 0.055px;
      line-height: 16px;
    }

    .errors-list {
      color: var(--color-text-danger);
      font-size: 11px;
      font-weight: 450;
      line-height: 16px;
      letter-spacing: 0.055px;
    }

    .errors-list ul {
      list-style: disc;
      padding-left: 16.5px;
      margin: 0;
    }

    .errors-list li {
      margin-bottom: 0;
    }

    .errors-list li:last-child {
      margin-bottom: 0;
    }

    /* Suggested Box */
    .suggested-box {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-medium);
      padding: var(--spacer-2);
      display: flex;
      flex-direction: column;
      gap: var(--spacer-1);
    }

    .suggested-label {
      font-size: 11px;
      font-weight: 450;
      color: var(--color-text-secondary);
      letter-spacing: 0.055px;
      line-height: 16px;
    }

    .suggested-name {
      font-family: var(--font-family);
      font-size: 11px;
      font-weight: 450;
      color: var(--color-text);
      letter-spacing: 0.055px;
      line-height: 16px;
    }

    /* Errors Box */
    .errors-box {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-medium);
      padding: var(--spacer-2);
      display: flex;
      flex-direction: column;
      gap: var(--spacer-1);
    }

    /* Actions */
    .actions {
      display: flex;
      gap: var(--spacer-4);
      margin-top: var(--spacer-2);
    }

    .btn {
      flex: 1;
      height: var(--height-input);
      padding: var(--spacer-1) var(--spacer-2);
      border-radius: var(--radius-medium);
      font-family: var(--font-family);
      font-size: 11px;
      font-weight: 450;
      letter-spacing: 0.055px;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--color-bordertranslucent);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: var(--color-bg-secondary);
    }

    .btn-primary {
      background: var(--color-bg-brand);
      color: var(--color-text-onbrand);
      border: none;
    }

    .btn-primary:hover {
      background: #0b7dd6;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    /* Empty State */
    .empty-state {
      background: var(--color-bg-secondary);
      border-radius: var(--radius-medium);
      padding: var(--spacer-2);
      text-align: center;
    }

    .empty-state-text {
      font-size: 11px;
      font-weight: 450;
      line-height: 16px;
      color: var(--color-text-secondary);
      letter-spacing: 0.055px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--color-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--color-bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }



    /* Valid Card */
    .valid-label {
      font-size: 11px;
      font-weight: 450;
      color: var(--color-text-secondary);
      letter-spacing: 0.055px;
      line-height: 16px;
    }

    .valid-name {
      font-family: var(--font-family);
      font-size: 11px;
      font-weight: 450;
      color: var(--color-text);
      letter-spacing: 0.055px;
      line-height: 16px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="plugin-container">
    <!-- Content -->
    <div class="content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-scope="selected">Current layer</button>
        <button class="tab" data-scope="page">
          Current page
          <span class="tab-badge hidden" id="pageBadge">0</span>
        </button>
      </div>

      <!-- Input Section -->
      <div class="input-section" id="inputSection">
        <div class="input-label">Layer select</div>
        <div class="input-wrapper">
          <span class="badge" id="layerBadge">task_</span>
        </div>
      </div>

      <!-- Results Container -->
      <div class="cards" id="results"></div>
    </div>
  </div>

  <script>
    // Estado global
    let validationResults = [];
    let currentScope = 'selected';

    // Elementos do DOM
    const tabs = document.querySelectorAll('.tab');
    const resultsContainer = document.getElementById('results');
    const layerBadge = document.getElementById('layerBadge');
    const pageBadge = document.getElementById('pageBadge');
    const inputSection = document.getElementById('inputSection');

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentScope = tab.dataset.scope;
        triggerValidation();
      });
    });

    // Função para validar baseado no estado atual
    function triggerValidation() {
      const applyToPage = currentScope === 'page';
      
      parent.postMessage({
        pluginMessage: {
          type: 'selection-changed',
          applyToPage: applyToPage
        }
      }, '*');
    }

    // Função para criar card de layer válida
    function createValidCard(result) {
      const card = document.createElement('div');
      card.className = 'card';
      
      card.innerHTML = `
        <div class="valid-label">✅ Valid</div>
        <div class="valid-name">${escapeHtml(result.currentName)}</div>
      `;
      
      return card;
    }

    // Função para criar card BATCH de layers válidas
    function createBatchValidCard(results) {
      const card = document.createElement('div');
      card.className = 'card';
      
      const firstName = results[0].currentName;
      
      card.innerHTML = `
        <div class="valid-label">✅ Valid</div>
        <div class="valid-name">${escapeHtml(firstName)}</div>
      `;
      
      return card;
    }

    // Função para criar card BATCH de layers inválidas
    function createBatchInvalidCard(results) {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.gap = 'var(--spacer-2)';
      
      const result = results[0];
      const errorsHtml = result.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('');
      
      container.innerHTML = `
        <div class="suggested-box">
          <div class="suggested-label">Suggested</div>
          <div class="suggested-name">${escapeHtml(result.suggestedName)}</div>
        </div>
        <div class="errors-box">
          <div class="errors-label">❌ Errors</div>
          <div class="errors-list">
            <ul>${errorsHtml}</ul>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary batch-fix-btn">Fix all</button>
        </div>
      `;
      
      const fixBtn = container.querySelector('.batch-fix-btn');
      fixBtn.addEventListener('click', () => {
        const fixes = results.map(r => ({
          nodeId: r.nodeId,
          newName: r.suggestedName
        }));
        
        parent.postMessage({
          pluginMessage: {
            type: 'fix-all',
            fixes
          }
        }, '*');
        
        setTimeout(() => {
          triggerValidation();
        }, 100);
      });
      
      return container;
    }

    // Função para criar card de layer inválida
    function createInvalidCard(result) {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.gap = 'var(--spacer-2)';
      
      const errorsHtml = result.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('');
      const buttonText = currentScope === 'selected' ? 'Fix' : 'Fix all';
      
      container.innerHTML = `
        <div class="suggested-box">
          <div class="suggested-label">Suggested</div>
          <div class="suggested-name">${escapeHtml(result.suggestedName)}</div>
        </div>
        <div class="errors-box">
          <div class="errors-label">❌ Errors</div>
          <div class="errors-list">
            <ul>${errorsHtml}</ul>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary apply-fix-btn">${buttonText}</button>
        </div>
      `;
      
      const fixBtn = container.querySelector('.apply-fix-btn');
      fixBtn.addEventListener('click', () => {
        parent.postMessage({
          pluginMessage: {
            type: 'apply-fix',
            nodeId: result.nodeId,
            newName: result.suggestedName
          }
        }, '*');
        
        setTimeout(() => {
          triggerValidation();
        }, 100);
      });
      
      return container;
    }

    // Função para calcular dimensões baseada no conteúdo real
    function calculateRequiredSize() {
      const content = document.querySelector('.plugin-container');
      const contentHeight = content.offsetHeight;
      const maxHeight = 650;
      
      return {
        width: 264,
        height: Math.min(contentHeight, maxHeight)
      };
    }

    // Função para renderizar resultados
    function renderResults(results) {
      validationResults = results;
      resultsContainer.innerHTML = '';
      
      if (results.length === 0) {
        // Esconde o "Layer select" quando não há resultados
        inputSection.classList.add('hidden');
        
        // Esconde a badge do tab "Current page"
        pageBadge.classList.add('hidden');
        
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
          <div class="empty-state-text">Select a layer to validate its nomenclature</div>
        `;
        resultsContainer.appendChild(emptyState);
        
        // Força o navegador a recalcular o layout antes de redimensionar
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const size = calculateRequiredSize();
            parent.postMessage({
              pluginMessage: {
                type: 'resize',
                width: size.width,
                height: size.height
              }
            }, '*');
          });
        });
        
        return;
      }
      
      // Mostra o "Layer select" quando há resultados
      inputSection.classList.remove('hidden');
      
      // Atualiza o badge com o nome completo da layer selecionada
      layerBadge.textContent = results[0].currentName;
      
      // Atualiza badge no tab "Current page" (só mostra se houver mais de 1 layer)
      if (results.length > 1) {
        pageBadge.textContent = results.length.toString();
        pageBadge.classList.remove('hidden');
      } else {
        pageBadge.classList.add('hidden');
      }
      
      const invalidResults = results.filter(r => !r.isValid);
      const validResults = results.filter(r => r.isValid);
      
      // MODO BATCH: Se há múltiplos resultados no modo página
      const isBatchMode = results.length > 1 && currentScope === 'page';
      
      if (isBatchMode) {
        
        // Se houver inválidos, mostra APENAS 1 CARD com a quantidade
        if (invalidResults.length > 0) {
          const card = createBatchInvalidCard(invalidResults);
          resultsContainer.appendChild(card);
        }
        
        // Se houver válidos, mostra APENAS 1 CARD com a quantidade
        if (validResults.length > 0) {
          const card = createBatchValidCard(validResults);
          resultsContainer.appendChild(card);
        }
      } else {
        // MODO NORMAL: Renderiza cada layer individualmente
        
        // Renderiza inválidos primeiro
        invalidResults.forEach(result => {
          resultsContainer.appendChild(createInvalidCard(result));
        });
        
        // Renderiza válidos depois
        validResults.forEach(result => {
          resultsContainer.appendChild(createValidCard(result));
        });
      }
      
      // Redimensiona após renderizar usando requestAnimationFrame para garantir que o DOM foi atualizado
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const size = calculateRequiredSize();
          parent.postMessage({
            pluginMessage: {
              type: 'resize',
              width: size.width,
              height: size.height
            }
          }, '*');
        });
      });
    }

    // Função auxiliar para escapar HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Listener para mensagens do plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg && msg.type === 'validation-results') {
        renderResults(msg.results);
      } else if (msg && msg.type === 'trigger-validation') {
        triggerValidation();
      }
    };

    // Redimensiona ao carregar a página inicialmente
    window.addEventListener('load', () => {
      setTimeout(() => {
        const size = calculateRequiredSize();
        parent.postMessage({
          pluginMessage: {
            type: 'resize',
            width: size.width,
            height: size.height
          }
        }, '*');
        
        // Valida a seleção inicial
        triggerValidation();
      }, 100);
    });
  </script>
</body>
</html>
