<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      padding: 16px;
      background: #fff;
    }

    h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #000;
    }

    .controls {
      margin-bottom: 16px;
    }

    .toggle-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .toggle-btn {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }

    .toggle-btn:hover {
      background: #f5f5f5;
    }

    .toggle-btn.active {
      background: #0066ff;
      color: #fff;
      border-color: #0066ff;
    }

    .validate-btn {
      width: 100%;
      padding: 10px;
      background: #0066ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .validate-btn:hover {
      background: #0052cc;
    }

    .validate-btn:active {
      background: #003d99;
    }

    .results {
      margin-top: 16px;
    }

    .card {
      background: #f9f9f9;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 12px;
    }

    .card-header.valid {
      color: #00aa00;
    }

    .card-header.invalid {
      color: #ff3b30;
    }

    .card-header .icon {
      font-size: 14px;
    }

    .card-body {
      font-size: 11px;
      line-height: 1.5;
    }

    .layer-name {
      margin-bottom: 8px;
    }

    .current-name {
      color: #666;
      margin-bottom: 4px;
    }

    .current-name strong {
      color: #000;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
    }

    .suggested-name {
      color: #666;
      margin-bottom: 8px;
    }

    .suggested-name strong {
      color: #0066ff;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
    }

    .errors {
      margin-bottom: 8px;
    }

    .errors-title {
      color: #666;
      margin-bottom: 4px;
    }

    .errors ul {
      list-style: none;
      padding-left: 8px;
    }

    .errors li {
      color: #ff3b30;
      margin-bottom: 2px;
    }

    .errors li:before {
      content: "• ";
      margin-right: 4px;
    }

    .apply-btn {
      width: 100%;
      padding: 8px;
      background: #fff;
      color: #0066ff;
      border: 1px solid #0066ff;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .apply-btn:hover {
      background: #0066ff;
      color: #fff;
    }

    .fix-all-btn {
      width: 100%;
      padding: 12px;
      background: #0066ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
    }

    .fix-all-btn:hover {
      background: #0052cc;
    }

    .fix-all-btn:active {
      background: #003d99;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 12px;
    }

    .valid-layer-name {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      color: #000;
      text-align: center;
      padding: 8px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Layer Naming Validator</h1>
  
  <div class="controls">
    <div class="toggle-group">
      <button class="toggle-btn active" data-scope="selected">Selected Layers</button>
      <button class="toggle-btn" data-scope="page">Current Page</button>
    </div>
    <button class="validate-btn">Validate</button>
  </div>

  <div class="results">
    <div class="empty-state">
      Select layers to validate
    </div>
  </div>

  <script>
    // Estado global
    let currentScope = 'selected';
    let validationResults = [];

    // Elementos do DOM
    const toggleButtons = document.querySelectorAll('.toggle-btn');
    const validateButton = document.querySelector('.validate-btn');
    const resultsContainer = document.querySelector('.results');

    // Toggle entre "Selected Layers" e "Current Page"
    toggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active de todos
        toggleButtons.forEach(btn => btn.classList.remove('active'));
        // Adiciona active no clicado
        button.classList.add('active');
        // Atualiza scope
        currentScope = button.dataset.scope;
      });
    });

    // Botão de validar
    validateButton.addEventListener('click', () => {
      console.log('Botão validate clicado, scope:', currentScope);
      
      // Envia mensagem para o plugin
      parent.postMessage({
        pluginMessage: {
          type: 'validate',
          scope: currentScope
        }
      }, '*');
      
      console.log('Mensagem enviada para o plugin');
    });

    // Função para criar card de layer válida
    function createValidCard(result) {
      const card = document.createElement('div');
      card.className = 'card';
      
      card.innerHTML = `
        <div class="card-header valid">
          <span class="icon">✅</span>
          <span>Valid</span>
        </div>
        <div class="card-body">
          <div class="valid-layer-name">${escapeHtml(result.currentName)}</div>
        </div>
      `;
      
      return card;
    }

    // Função para criar card de layer inválida
    function createInvalidCard(result) {
      const card = document.createElement('div');
      card.className = 'card';
      
      const errorsHtml = result.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('');
      
      card.innerHTML = `
        <div class="card-header invalid">
          <span class="icon">❌</span>
          <span>Invalid</span>
        </div>
        <div class="card-body">
          <div class="layer-name">
            <div class="current-name">
              Current: <strong>${escapeHtml(result.currentName)}</strong>
            </div>
            <div class="suggested-name">
              Suggested: <strong>${escapeHtml(result.suggestedName)}</strong>
            </div>
          </div>
          <div class="errors">
            <div class="errors-title">Errors:</div>
            <ul>${errorsHtml}</ul>
          </div>
          <button class="apply-btn" data-node-id="${result.nodeId}" data-new-name="${escapeHtml(result.suggestedName)}">
            Apply Fix
          </button>
        </div>
      `;
      
      // Adiciona listener ao botão
      const applyBtn = card.querySelector('.apply-btn');
      applyBtn.addEventListener('click', () => {
        parent.postMessage({
          pluginMessage: {
            type: 'apply-fix',
            nodeId: result.nodeId,
            newName: result.suggestedName
          }
        }, '*');
        
        // Re-valida após aplicar
        setTimeout(() => {
          parent.postMessage({
            pluginMessage: {
              type: 'validate',
              scope: currentScope
            }
          }, '*');
        }, 100);
      });
      
      return card;
    }

    // Função para criar botão "Fix All"
    function createFixAllButton(invalidResults) {
      const button = document.createElement('button');
      button.className = 'fix-all-btn';
      button.textContent = 'Fix All';
      
      button.addEventListener('click', () => {
        const fixes = invalidResults.map(result => ({
          nodeId: result.nodeId,
          newName: result.suggestedName
        }));
        
        parent.postMessage({
          pluginMessage: {
            type: 'fix-all',
            fixes
          }
        }, '*');
        
        // Re-valida após aplicar
        setTimeout(() => {
          parent.postMessage({
            pluginMessage: {
              type: 'validate',
              scope: currentScope
            }
          }, '*');
        }, 100);
      });
      
      return button;
    }

    // Função para renderizar resultados
    function renderResults(results) {
      validationResults = results;
      resultsContainer.innerHTML = '';
      
      if (results.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.textContent = currentScope === 'selected' 
          ? 'Select layers to validate' 
          : 'No layers found on current page';
        resultsContainer.appendChild(emptyState);
        return;
      }
      
      const invalidResults = results.filter(r => !r.isValid);
      const validResults = results.filter(r => r.isValid);
      
      // Renderiza inválidos primeiro
      invalidResults.forEach(result => {
        resultsContainer.appendChild(createInvalidCard(result));
      });
      
      // Renderiza válidos depois
      validResults.forEach(result => {
        resultsContainer.appendChild(createValidCard(result));
      });
      
      // Adiciona botão "Fix All" se houver múltiplas layers inválidas
      if (invalidResults.length > 1) {
        resultsContainer.appendChild(createFixAllButton(invalidResults));
      }
    }

    // Função auxiliar para escapar HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Listener para mensagens do plugin
    window.onmessage = (event) => {
      console.log('Mensagem recebida da UI:', event.data);
      const msg = event.data.pluginMessage;
      
      if (msg && msg.type === 'validation-results') {
        console.log('Renderizando resultados:', msg.results);
        renderResults(msg.results);
      }
    };
  </script>
</body>
</html>
