<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      line-height: 1;
      color: #ffffff;
      padding: 0;
      background: #2c2c2c;
      overflow: hidden;
    }

    .content {
      padding: 16px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: #18a0fb;
    }

    .checkbox-wrapper label {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      color: #fff;
      cursor: pointer;
      font-weight: 500;
    }

    .validate-btn {
      width: 100%;
      height: 28px;
      padding: 0 16px;
      background: #18a0fb;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .validate-btn:hover {
      background: #1592e6;
    }

    .validate-btn:active {
      transform: scale(0.98);
    }

    .results {
      margin-top: 16px;
    }
    
    .results:empty {
      display: none;
    }

    .card {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 8px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-header.valid {
      color: #4ade80;
    }

    .card-header.invalid {
      color: #f87171;
    }

    .card-header .icon {
      font-size: 12px;
    }

    .card-body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      line-height: 1.5;
    }

    .layer-name {
      margin-bottom: 16px;
      background: #2c2c2c;
      padding: 12px;
      border-radius: 6px;
    }

    .current-name {
      color: #999;
      margin-bottom: 8px;
      font-size: 10px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .current-name strong {
      color: #fff;
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      font-weight: 500;
      display: block;
      margin-top: 4px;
    }

    .suggested-name {
      color: #999;
      margin-bottom: 0;
      font-size: 10px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .suggested-name strong {
      color: #0d99ff;
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      font-weight: 600;
      display: block;
      margin-top: 4px;
    }

    .errors {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(248, 113, 113, 0.08);
      border-radius: 6px;
    }

    .errors-title {
      color: #f87171;
      margin-bottom: 8px;
      font-size: 10px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .errors ul {
      list-style: none;
      padding-left: 0;
    }

    .errors li {
      color: #fca5a5;
      margin-bottom: 4px;
      font-size: 10px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding-left: 12px;
      position: relative;
      line-height: 1.4;
    }

    .errors li:last-child {
      margin-bottom: 0;
    }

    .errors li:before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: #f87171;
    }

    .apply-btn {
      width: 100%;
      height: 32px;
      padding: 0 16px;
      background: #18a0fb;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(24, 160, 251, 0.3);
    }

    .apply-btn:hover {
      background: #0b7dd6;
      box-shadow: 0 4px 12px rgba(24, 160, 251, 0.4);
      transform: translateY(-1px);
    }

    .apply-btn:active {
      transform: translateY(0) scale(0.98);
    }

    .batch-fix-btn {
      height: 36px;
      font-size: 12px;
      background: linear-gradient(135deg, #18a0fb 0%, #0d99ff 100%);
      box-shadow: 0 4px 12px rgba(24, 160, 251, 0.4);
    }

    .batch-fix-btn:hover {
      background: linear-gradient(135deg, #0b7dd6 0%, #0d8fe6 100%);
      box-shadow: 0 6px 16px rgba(24, 160, 251, 0.5);
    }

    .fix-all-btn {
      width: 100%;
      height: 32px;
      padding: 0 16px;
      background: #18a0fb;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(24, 160, 251, 0.3);
    }

    .fix-all-btn:hover {
      background: #0b7dd6;
      box-shadow: 0 4px 12px rgba(24, 160, 251, 0.4);
      transform: translateY(-1px);
    }

    .fix-all-btn:active {
      transform: translateY(0) scale(0.98);
    }

    .batch-card {
      border: 2px solid #18a0fb;
    }

    .batch-success-message {
      text-align: center;
      padding: 16px;
    }

    .batch-count {
      font-size: 24px;
      font-weight: 700;
      color: #4ade80;
      margin-bottom: 8px;
    }

    .batch-name {
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      color: #fff;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .batch-description {
      font-size: 11px;
      color: #999;
      line-height: 1.5;
    }

    .empty-state {
      display: none;
    }

    .empty-state-message {
      text-align: center;
      padding: 32px 16px;
      color: #999;
    }

    .empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .empty-text {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      line-height: 1.5;
      color: #999;
    }

    .batch-mode-badge {
      background: rgba(24, 160, 251, 0.15);
      border: 1px solid rgba(24, 160, 251, 0.3);
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 10px;
      color: #18a0fb;
      font-weight: 500;
    }

    .badge-icon {
      font-size: 14px;
    }

    .badge-text {
      line-height: 1.4;
    }

    .valid-layer-name {
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: #fff;
      text-align: center;
      padding: 12px;
      background: #2c2c2c;
      border-radius: 6px;
      font-weight: 500;
    }

    .hidden {
      display: none;
    }

    /* Scrollbar dark theme */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #3a3a3a;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4a4a4a;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="controls">
      <div class="checkbox-wrapper">
        <input type="checkbox" id="applyToPage" />
        <label for="applyToPage">Apply to current page</label>
      </div>
      <button class="validate-btn">Validate</button>
    </div>

    <div class="results"></div>
  </div>

  <script>
    // Estado global
    let validationResults = [];

    // Elementos do DOM
    const applyToPageCheckbox = document.getElementById('applyToPage');
    const validateButton = document.querySelector('.validate-btn');
    const resultsContainer = document.querySelector('.results');

    // Fun√ß√£o para validar baseado no estado atual
    function triggerValidation() {
      const applyToPage = applyToPageCheckbox.checked;
      
      parent.postMessage({
        pluginMessage: {
          type: 'selection-changed',
          applyToPage: applyToPage
        }
      }, '*');
    }

    // Listener para mudan√ßas no checkbox
    applyToPageCheckbox.addEventListener('change', () => {
      triggerValidation();
    });

    // Bot√£o de validar (agora for√ßa valida√ß√£o da p√°gina toda)
    validateButton.addEventListener('click', () => {
      const scope = applyToPageCheckbox.checked ? 'page' : 'selected';
      
      parent.postMessage({
        pluginMessage: {
          type: 'validate',
          scope: scope
        }
      }, '*');
    });

    // Fun√ß√£o para criar card de layer v√°lida
    function createValidCard(result) {
      const card = document.createElement('div');
      card.className = 'card';
      
      card.innerHTML = `
        <div class="card-header valid">
          <span class="icon">‚úÖ</span>
          <span>Valid</span>
        </div>
        <div class="card-body">
          <div class="valid-layer-name">${escapeHtml(result.currentName)}</div>
        </div>
      `;
      
      return card;
    }

    // Fun√ß√£o para criar card BATCH de layers v√°lidas
    function createBatchValidCard(results) {
      const card = document.createElement('div');
      card.className = 'card batch-card';
      
      card.innerHTML = `
        <div class="card-header valid">
          <span class="icon">‚úÖ</span>
          <span>Valid</span>
        </div>
        <div class="card-body">
          <div class="batch-success-message">
            <div class="batch-count">${results.length} layers</div>
            <div class="batch-name">${escapeHtml(results[0].currentName)}</div>
            <div class="batch-description">All layers have correct nomenclature! üéâ</div>
          </div>
        </div>
      `;
      
      return card;
    }

    // Fun√ß√£o para criar card BATCH de layers inv√°lidas
    function createBatchInvalidCard(results) {
      const card = document.createElement('div');
      card.className = 'card batch-card';
      
      const result = results[0]; // Usa o primeiro como refer√™ncia
      const errorsHtml = result.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('');
      
      card.innerHTML = `
        <div class="card-header invalid">
          <span class="icon">‚ùå</span>
          <span>Invalid (${results.length} layers)</span>
        </div>
        <div class="card-body">
          <div class="layer-name">
            <div class="current-name">
              Current: <strong>${escapeHtml(result.currentName)}</strong>
            </div>
            <div class="suggested-name">
              Suggested: <strong>${escapeHtml(result.suggestedName)}</strong>
            </div>
          </div>
          <div class="errors">
            <div class="errors-title">Errors:</div>
            <ul>${errorsHtml}</ul>
          </div>
          <button class="apply-btn batch-fix-btn">
            ‚ú® Fix All ${results.length} Layers
          </button>
        </div>
      `;
      
      // Adiciona listener ao bot√£o
      const applyBtn = card.querySelector('.apply-btn');
      applyBtn.addEventListener('click', () => {
        const fixes = results.map(r => ({
          nodeId: r.nodeId,
          newName: r.suggestedName
        }));
        
        parent.postMessage({
          pluginMessage: {
            type: 'fix-all',
            fixes
          }
        }, '*');
        
        // Re-valida ap√≥s aplicar
        setTimeout(() => {
          triggerValidation();
        }, 100);
      });
      
      return card;
    }

    // Fun√ß√£o para criar card de layer inv√°lida
    function createInvalidCard(result) {
      const card = document.createElement('div');
      card.className = 'card';
      
      const errorsHtml = result.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('');
      
      card.innerHTML = `
        <div class="card-header invalid">
          <span class="icon">‚ùå</span>
          <span>Invalid</span>
        </div>
        <div class="card-body">
          <div class="layer-name">
            <div class="current-name">
              Current: <strong>${escapeHtml(result.currentName)}</strong>
            </div>
            <div class="suggested-name">
              Suggested: <strong>${escapeHtml(result.suggestedName)}</strong>
            </div>
          </div>
          <div class="errors">
            <div class="errors-title">Errors:</div>
            <ul>${errorsHtml}</ul>
          </div>
          <button class="apply-btn" data-node-id="${result.nodeId}" data-new-name="${escapeHtml(result.suggestedName)}">
            Apply Fix
          </button>
        </div>
      `;
      
      // Adiciona listener ao bot√£o
      const applyBtn = card.querySelector('.apply-btn');
      applyBtn.addEventListener('click', () => {
        parent.postMessage({
          pluginMessage: {
            type: 'apply-fix',
            nodeId: result.nodeId,
            newName: result.suggestedName
          }
        }, '*');
        
        // Re-valida ap√≥s aplicar usando o modo inteligente
        setTimeout(() => {
          triggerValidation();
        }, 100);
      });
      
      return card;
    }

    // Fun√ß√£o para criar bot√£o "Fix All"
    function createFixAllButton(invalidResults) {
      const button = document.createElement('button');
      button.className = 'fix-all-btn';
      button.textContent = 'Fix All';
      
      button.addEventListener('click', () => {
        const fixes = invalidResults.map(result => ({
          nodeId: result.nodeId,
          newName: result.suggestedName
        }));
        
        parent.postMessage({
          pluginMessage: {
            type: 'fix-all',
            fixes
          }
        }, '*');
        
        // Re-valida ap√≥s aplicar usando o modo inteligente
        setTimeout(() => {
          triggerValidation();
        }, 100);
      });
      
      return button;
    }

    // Fun√ß√£o para calcular dimens√µes baseada no conte√∫do real
    function calculateRequiredSize() {
      // Mede a altura real do conte√∫do (que j√° inclui o padding de 16px)
      const content = document.querySelector('.content');
      const contentHeight = content.offsetHeight;
      const maxHeight = 650;
      
      return {
        width: 240,
        height: Math.min(contentHeight, maxHeight)
      };
    }

    // Fun√ß√£o para renderizar resultados
    function renderResults(results) {
      validationResults = results;
      resultsContainer.innerHTML = '';
      
      if (results.length === 0) {
        // Mostra mensagem para selecionar layers
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state-message';
        emptyState.innerHTML = `
          <div class="empty-icon">üëÜ</div>
          <div class="empty-text">Select a layer to validate its nomenclature</div>
        `;
        resultsContainer.appendChild(emptyState);
        
        setTimeout(() => {
          const size = calculateRequiredSize();
          parent.postMessage({
            pluginMessage: {
              type: 'resize',
              width: size.width,
              height: size.height
            }
          }, '*');
        }, 50);
        
        return;
      }
      
      const invalidResults = results.filter(r => !r.isValid);
      const validResults = results.filter(r => r.isValid);
      
      // MODO BATCH: Se h√° m√∫ltiplos resultados no modo inteligente
      const isBatchMode = results.length > 1 && applyToPageCheckbox.checked;
      
      if (isBatchMode) {
        // Mostra badge informativo
        const badge = document.createElement('div');
        badge.className = 'batch-mode-badge';
        badge.innerHTML = `
          <span class="badge-icon">üîç</span>
          <span class="badge-text">Found ${results.length} layers with the same name</span>
        `;
        resultsContainer.appendChild(badge);
        
        // Se houver inv√°lidos, mostra APENAS 1 CARD com a quantidade
        if (invalidResults.length > 0) {
          const card = createBatchInvalidCard(invalidResults);
          resultsContainer.appendChild(card);
        }
        
        // Se houver v√°lidos, mostra APENAS 1 CARD com a quantidade
        if (validResults.length > 0) {
          const card = createBatchValidCard(validResults);
          resultsContainer.appendChild(card);
        }
      } else {
        // MODO NORMAL: Renderiza cada layer individualmente
        
        // Renderiza inv√°lidos primeiro
        invalidResults.forEach(result => {
          resultsContainer.appendChild(createInvalidCard(result));
        });
        
        // Renderiza v√°lidos depois
        validResults.forEach(result => {
          resultsContainer.appendChild(createValidCard(result));
        });
        
        // Adiciona bot√£o "Fix All" se houver m√∫ltiplas layers inv√°lidas
        if (invalidResults.length > 1) {
          const fixAllBtn = createFixAllButton(invalidResults);
          resultsContainer.appendChild(fixAllBtn);
        }
      }
      
      // Redimensiona ap√≥s renderizar (aguarda o DOM atualizar)
      setTimeout(() => {
        const size = calculateRequiredSize();
        parent.postMessage({
          pluginMessage: {
            type: 'resize',
            width: size.width,
            height: size.height
          }
        }, '*');
      }, 150);
    }

    // Fun√ß√£o auxiliar para escapar HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Listener para mensagens do plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg && msg.type === 'validation-results') {
        renderResults(msg.results);
      } else if (msg && msg.type === 'trigger-validation') {
        // Plugin notificou que a sele√ß√£o mudou, vamos validar
        triggerValidation();
      }
    };

    // Redimensiona ao carregar a p√°gina inicialmente
    window.addEventListener('load', () => {
      setTimeout(() => {
        const size = calculateRequiredSize();
        parent.postMessage({
          pluginMessage: {
            type: 'resize',
            width: size.width,
            height: size.height
          }
        }, '*');
        
        // Valida a sele√ß√£o inicial
        triggerValidation();
      }, 100);
    });
  </script>
</body>
</html>
